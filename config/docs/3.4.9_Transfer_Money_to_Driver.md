# 3.4.9 Transfer Money to Driver

## Function trigger
The admin navigates to the driver detail page or driver management section, selects a specific driver, and clicks on the "Transfer Money" or "Payout" button, or accesses the payout function from the driver's profile page in the admin dashboard.

## Function description
Allows the admin to transfer money directly to a driver's account by deducting a specified amount from the driver's income balance. The system validates that the driver has sufficient balance, deducts the amount, creates a transaction record, and updates the driver's balance. This function is used for manual payouts or administrative transfers to drivers outside of the normal withdrawal request process.

## Screen layout
The screen consists of:
- Header section displaying driver information (name, ID, current balance)
- Transfer form section containing:
  - Driver information display (read-only): Driver name, Driver ID, Current balance
  - Amount input field (number type, required, minimum: 1)
  - Description/Notes text area (optional, for admin notes about the transfer)
  - Submit button ("Transfer Money" or "Chuyển tiền")
  - Cancel button to close the form
- Success/error message display area
- Transaction history section (optional, showing recent transfers to this driver)

## Function details

### Data
- Driver ID (retrieved from route parameter or selected driver)
- Amount (number, required, must be positive integer, minimum: 1 VND)
- Description (string, optional, admin notes about the transfer)
- Admin ID (retrieved from authentication token)
- Current driver balance (incomeBalance from Driver model)
- Transaction timestamp (createdAt)
- Transaction ID (generated after transaction creation)

### Validation
- The admin must be authenticated (valid JWT token required).
- Admin must have Admin role (authorize(roles.ADMIN)).
- Driver ID must be provided and must exist in the database.
- Amount field is required and cannot be empty.
- Amount must be a positive number greater than 0.
- Amount must be rounded to the nearest integer (no decimals).
- Driver's current balance (incomeBalance) must be greater than or equal to the transfer amount.
- Description field is optional and can be empty.

### Business rule
- BR-21: Only admin users can transfer money to drivers.
- BR-22: The transfer amount cannot exceed the driver's current income balance.
- BR-23: After a successful transfer, the driver's income balance is reduced by the transfer amount.
- BR-24: Each transfer must create a transaction record in the DriverTransaction collection with type "Withdrawal" and status "Completed".
- BR-25: The transaction record must include the full amount as both amount and netAmount (no fee is deducted for admin transfers).
- BR-26: The payment method for admin transfers is recorded as "BankTransfer".

### Functionality

#### In Normal Cases:
- The admin navigates to the driver detail page or selects a driver from the driver management list.
- The admin clicks on "Transfer Money" or "Payout" button for the selected driver.
- The system displays the transfer form with the driver's current balance information.
- The admin enters the amount to transfer in the "Amount" field (must be a positive number).
- The admin optionally enters a description or note about the transfer.
- The system validates that:
  - The driver exists in the database
  - The amount is a positive number greater than 0
  - The driver's current balance is sufficient (balance >= amount)
- If all validations pass, the system:
  - Rounds the amount to the nearest integer
  - Deducts the amount from the driver's incomeBalance
  - Saves the updated driver record
  - Creates a DriverTransaction record with:
    - driverId: The driver's ID
    - amount: The transfer amount
    - fee: 0 (no fee for admin transfers)
    - netAmount: The transfer amount (same as amount)
    - type: "Withdrawal"
    - status: "Completed"
    - description: The provided description or default "Admin chi trả về tài khoản tài xế"
    - paymentMethod: "BankTransfer"
    - transactionDate: Current timestamp
  - Returns a success response with the updated driver balance
- A success message is displayed: "Đã chi trả cho tài xế" (Money transferred successfully to driver).
- The driver's balance is updated and displayed in real-time.
- The transaction is recorded in the driver's transaction history.

#### In Abnormal Cases:
- If driver ID is missing or invalid → message: "Driver ID is required" or "Vui lòng chọn tài xế".
- If driver is not found → system returns 404 Not Found error with message: "Không tìm thấy tài xế" (Driver not found).
- If amount field is empty → message: "Amount is required" or "Vui lòng nhập số tiền".
- If amount is not a number or is less than or equal to 0 → system returns 400 Bad Request error with message: "Số tiền không hợp lệ" (Invalid amount).
- If amount is not a positive integer → system rounds it to the nearest integer.
- If driver's balance is insufficient (balance < amount) → system returns 400 Bad Request error with message: "Số dư không đủ để chi trả" (Insufficient balance for transfer).
- If admin is not authenticated → system returns 401 Unauthorized error with message: "Please log in" or "Vui lòng đăng nhập".
- If user is not an admin → system returns 403 Forbidden error with message: "Không có quyền truy cập" (Access denied).
- If database update fails → system returns 500 Internal Server Error with message: "Lỗi chi trả" (Transfer error) and error details.
- If transaction creation fails → system attempts to rollback the balance update and returns an error message.
- If driver record save fails → system returns 500 error with message: "Unable to save driver record. Please try again later." or "Không thể lưu thông tin tài xế. Vui lòng thử lại sau."









